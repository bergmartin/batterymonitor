# OTA (Over-The-Air) Updates

The battery monitor supports multiple OTA update methods with persistent trigger support and automatic version checking.

## Features

- ✅ **Persistent OTA Triggers** - MQTT OTA requests survive deep sleep and are processed on next boot
- ✅ **Automatic Version Checking** - Device can auto-check and install newer firmware versions  
- ✅ **Config-Based Updates** - Set target version via serial command or MQTT
- ✅ **Secure** - Base URL compiled into firmware, only filenames accepted via MQTT
- ✅ **Deep Sleep Compatible** - OTA triggers persist across sleep cycles

## Update Methods

### 1. Automatic Version-Based Updates (Recommended)

Set a target version and the device automatically downloads and installs it on next wake.

**Configure target version via serial:**
```bash
# Connect via serial and type:
otaver 1.0.2
save

# Device will check for and install v1.0.2 on next wake
```

**How it works:**
1. Set target version using `otaver` command
2. On every wake, device compares current version with target version
3. If target is newer, constructs URL: `BASE_URL/v1.0.2/firmware-leadacid.bin`
4. Downloads and installs firmware automatically
5. Version persists in NVS storage

**Enable/Disable:**
```cpp
// In battery_config.h
constexpr bool AUTO_CHECK_OTA = true;  // Set to false to disable
```

### 2. Manual MQTT-Triggered Updates

Immediately trigger an OTA update via MQTT. The trigger persists even if device is in deep sleep.

**Trigger with specific version:**
```bash
mosquitto_pub -h YOUR_MQTT_BROKER \
  -t "battery/monitor/ota" \
  -m "v1.0.2/firmware-leadacid.bin"
```

**Trigger ArduinoOTA mode:**
```bash
mosquitto_pub -h YOUR_MQTT_BROKER \
  -t "battery/monitor/ota" \
  -m "update"
```

**Deep Sleep Behavior:**
- If device is awake: OTA starts immediately
- If device is in deep sleep: Trigger is saved to persistent storage
- On next wake: Device checks for pending OTA and processes it before normal operation

### 3. ArduinoOTA (Network Upload)

Direct network upload using PlatformIO or Arduino IDE.

**Upload directly via network:**
```bash
# Configure platformio.ini with device IP:
# upload_protocol = espota
# upload_port = 192.168.1.XXX

pio run -t upload
```

**Or trigger OTA mode via MQTT first:**
```bash
mosquitto_pub -h YOUR_MQTT_BROKER \
  -t "battery/monitor/ota" \
  -m "update"
  
# Device waits 1 minute in OTA mode
# Then upload via PlatformIO
pio run -t upload
```

## Configuration

### Base URL Setup

Configure the base URL in `platformio.ini` (for GitHub releases):
```ini
build_flags = 
  -D BATTERY_TYPE=LEAD_ACID
  -D OTA_BASE_URL='"https://github.com/USERNAME/REPO/releases/download/"'
```

Or define in `ota_manager.h`:
```cpp
#ifndef OTA_BASE_URL
#define OTA_BASE_URL "https://github.com/USERNAME/REPO/releases/download/"
#endif
```

### Serial Commands

```bash
# Set target OTA version
otaver 1.0.2

# View current configuration (includes target version)
show

# Save configuration to NVS
save
```

### Firmware Naming Convention

Firmware files have simple names, with version in the URL path:
- Lead-Acid: `firmware-leadacid.bin` at URL path `v1.0.2/`
- LiFePO4: `firmware-lifepo4.bin` at URL path `v1.0.2/`
- Full URL: `BASE_URL/v1.0.2/firmware-leadacid.bin`

These are automatically generated by the GitHub Actions workflow.

## Release Workflow

### Creating a New Release

**1. Tag the version:**
```bash
git tag v1.0.2
git push origin v1.0.2
```

**2. GitHub Actions automatically:**
- Builds firmware with version embedded: `FIRMWARE_VERSION="1.0.2"`
- Creates firmware binaries:
  - `firmware-leadacid.bin`
  - `firmware-lifepo4.bin`
- Publishes to release at path: `releases/download/v1.0.2/`
- Creates GitHub release with all files

**3. Update devices:**

**Option A: Automatic (via serial config):**
```bash
# Connect via serial and set target version
otaver 1.0.2
save
# Device updates on next wake cycle
```

**Option B: Manual MQTT trigger:**
```bash
mosquitto_pub -h BROKER \
  -t "battery/monitor/ota" \
  -m "v1.0.2/firmware-leadacid.bin"
```

### Manual Build

Get firmware binary from PlatformIO build:

```bash
# Build the project
pio run

# Binary location:
.pio/build/esp32dev/firmware.bin
```

### Testing with Local Server

For local testing without GitHub:

1. **Configure local base URL:**
```ini
# In platformio.ini
-D OTA_BASE_URL='"http://192.168.1.100:8000/"'
```

2. **Serve the firmware:**
```bash
cd .pio/build/esp32dev/
python -m http.server 8000
```

3. **Trigger update:**
```bash
mosquitto_pub -h BROKER -t "battery/monitor/ota" -m "firmware.bin"
```

## Security Considerations

### Compile-Time Base URL
- Base URL is **hardcoded at compile time** and cannot be changed remotely
- Only filenames are accepted via MQTT (no paths, URLs, or special characters)
- Prevents injection of malicious firmware sources
- Must rebuild firmware to change base URL

### Input Validation
The device accepts:
- Path with version and filename: `v1.0.2/firmware-leadacid.bin`
- Simple filename for ArduinoOTA: `update` or empty

The device automatically rejects:
- Full URLs (containing `http://` or `https://`)
- Special characters (containing `:`)
- This prevents arbitrary firmware downloads

### HTTPS Recommendation
- Use HTTPS URLs for production (GitHub releases use HTTPS)
- HTTP acceptable for local testing only
- GitHub automatically provides secure TLS connections

### Password Protection

Optionally protect ArduinoOTA with a password in `ota_manager.cpp`:
```cpp
void OTAManager::setup() {
    ArduinoOTA.setHostname(config.mqttClientID.c_str());
    ArduinoOTA.setPassword("your_password");  // Uncomment and set password
    // ... rest of setup
}
```

## How Persistent OTA Works

### Storage Mechanism
OTA triggers are stored in ESP32's Preferences (NVS - Non-Volatile Storage):
- Survives deep sleep
- Survives power loss
- Survives reboots
- Persists until OTA completes or times out

### Boot Sequence
```
1. Device wakes from deep sleep
2. Check for pending OTA trigger in NVS
3. If pending:
   - Connect to WiFi
   - Download and install firmware
   - Clear OTA trigger on success/failure
4. Continue normal operation
```

### Automatic Version Check Flow
```
1. Device wakes from deep sleep
2. If AUTO_CHECK_OTA enabled:
   - Read otaTargetVersion from config
   - Compare with current FIRMWARE_VERSION
   - If target > current:
     - Construct path: v{target}/firmware-{type}.bin
     - Download and install
3. Continue normal operation
```

## Troubleshooting

### Update Fails
- Check base URL is correct in `platformio.ini` or `ota_manager.h`
- Verify filename matches exactly (case-sensitive)
- Ensure firmware file exists at `BASE_URL + filename`
- Check WiFi connection is stable
- Verify firmware is built for correct board
- Check serial output for detailed error messages

### Invalid Filename Error
If you see "ERROR: Invalid filename", the message contained:
- A colon (`:`)
- A full URL
- Send the path with version: `v1.0.2/firmware-leadacid.bin`

### Device Doesn't Respond to MQTT
- Verify MQTT topic matches: `battery/monitor/ota`
- Check device is connected to MQTT broker
- If in deep sleep: Trigger persists and will process on next wake
- Verify MQTT message was received (check broker logs)

### OTA Trigger Not Persisting
- Check serial output for "OTA trigger saved to persistent storage"
- Verify NVS is not full (unlikely with default settings)
- If cleared manually, use: `reset nvs` command restarts fresh

### Version Check Not Working
- Ensure AUTO_CHECK_OTA is true in battery_config.h
- Set target version: `otaver 1.0.2` and `save`
- Verify target version in config: `show` command
- Check serial output for version comparison logs

### Progress Monitoring
- Watch serial output during update
- HTTP updates show download progress percentage
- OTA timeout: 60 seconds for ArduinoOTA mode
- Check for "OTA trigger cleared" message on completion

## Power Considerations

During OTA updates, the device:
- Stays awake (80-160 mA current draw)
- ArduinoOTA mode: 60 seconds timeout
- HTTP update: ~30-60 seconds typical
- Returns to deep sleep after completion

**Power Budget:**
- Normal operation: ~0.1-0.3 mA average (99.9% in deep sleep)
- During OTA: ~100 mA for 30-60 seconds
- Minimal impact on battery life for infrequent updates

## Examples

### Complete Update Workflow

**1. Release new firmware:**
```bash
# Tag and push
git tag v1.0.3
git push origin v1.0.3

# GitHub Actions builds and releases automatically
```

**2. Update a single device (serial):**
```bash
# Connect via serial
otaver 1.0.3
save

# Device updates on next wake
```

**3. Update all devices (MQTT broadcast):**
```bash
# Option A: Set via MQTT to config (if implemented)
# Or use serial on each device

# Option B: Force immediate update
mosquitto_pub -h BROKER \
  -t "battery/monitor/ota" \
  -m "v1.0.3/firmware-leadacid.bin"
```

### Rollback to Previous Version

```bash
# Via serial
otaver 1.0.1
save

# Device downloads v1.0.1 on next wake
```

### Emergency Update (Device in Deep Sleep)

```bash
# Trigger via MQTT
mosquitto_pub -h BROKER \
  -t "battery/monitor/ota" \
  -m "v1.0.4/firmware-leadacid.bin"

# Trigger persists in NVS
# Processes automatically on next wake (up to 1 hour later)
```
