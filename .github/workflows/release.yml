name: Build and Release Firmware

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  validate-branch:
    runs-on: ubuntu-latest
    name: Validate release branch
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check major version release from main branch
        run: |
          TAG=${{ github.ref_name }}
          BRANCH=${{ github.ref }}
          
          # Extract version from tag (v1.2.3 -> 1.2.3)
          VERSION=${TAG#v}
          
          # Check if this is a major version release (X.0.0)
          if [[ $VERSION =~ ^[0-9]+\.0\.0$ ]]; then
            # Major version release must be from main branch
            if [[ ! "$BRANCH" =~ ^refs/heads/main$ ]]; then
              echo "❌ Error: Major version releases (v*.0.0) can only be tagged from the main branch"
              echo "Current branch: $BRANCH"
              exit 1
            fi
            echo "✓ Major version $VERSION correctly tagged from main branch"
          else
            echo "✓ Non-major version release: $VERSION"
          fi

  build:
    runs-on: ubuntu-latest
    needs: validate-branch
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Cache PlatformIO
        uses: actions/cache@v3
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-
      
      - name: Install PlatformIO
        run: |
          pip install --upgrade platformio
          pio --version
      
      - name: Create credential files
        run: |
          # Credentials are now stored in NVS (Non-Volatile Storage) on the ESP32
          # These values are only used as DEFAULTS on the very first boot
          # After first boot, credentials persist in NVS across all OTA updates
          
          # Option A: Placeholder defaults (recommended for public repos)
          # Each device will use these defaults on first boot only
          # Configure actual credentials via USB on first upload
          
          # Create wifi_credentials.h (with placeholder default values)
          cat > include/wifi_credentials.h << 'EOF'
          #ifndef WIFI_CREDENTIALS_H
          #define WIFI_CREDENTIALS_H
          
          #define WIFI_SSID "your-wifi-ssid"
          #define WIFI_PASSWORD "your-wifi-password"
          
          #endif
          EOF
          
          # Create mqtt_credentials.h (with placeholder default values)
          cat > include/mqtt_credentials.h << 'EOF'
          #ifndef MQTT_CREDENTIALS_H
          #define MQTT_CREDENTIALS_H
          
          #define MQTT_SERVER "mqtt.example.com"
          #define MQTT_PORT 1883
          #define MQTT_USER "mqtt-user"
          #define MQTT_PASSWORD "mqtt-password"
          #define MQTT_CLIENT_ID "battery-monitor"
          
          #endif
          EOF
          
          # Option B: Use GitHub Secrets as defaults (uncomment to use)
          # Set these secrets in GitHub: Settings -> Secrets and variables -> Actions
          # These become the default values on first boot for all devices
          
          # cat > include/wifi_credentials.h << EOF
          # #ifndef WIFI_CREDENTIALS_H
          # #define WIFI_CREDENTIALS_H
          # 
          # #define WIFI_SSID "${{ secrets.WIFI_SSID }}"
          # #define WIFI_PASSWORD "${{ secrets.WIFI_PASSWORD }}"
          # 
          # #endif
          # EOF
          # 
          # cat > include/mqtt_credentials.h << EOF
          # #ifndef MQTT_CREDENTIALS_H
          # #define MQTT_CREDENTIALS_H
          # 
          # #define MQTT_SERVER "${{ secrets.MQTT_SERVER }}"
          # #define MQTT_PORT ${{ secrets.MQTT_PORT }}
          # #define MQTT_USER "${{ secrets.MQTT_USER }}"
          # #define MQTT_PASSWORD "${{ secrets.MQTT_PASSWORD }}"
          # #define MQTT_CLIENT_ID "${{ secrets.MQTT_CLIENT_ID }}"
          # 
          # #endif
          # EOF
      
      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}  # Remove 'v' prefix if present
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Build firmware
        run: pio run -e esp32dev
        env:
          PLATFORMIO_BUILD_FLAGS: -D FIRMWARE_VERSION=\"${{ steps.version.outputs.version }}\"
      
      - name: Rename firmware files
        run: |
          # Simple filenames without version - version is in the release URL path
          cp .pio/build/esp32dev/firmware.bin firmware.bin
      
      - name: Generate checksums
        run: |
          sha256sum firmware*.bin > checksums.txt
          cat checksums.txt
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ github.token }}
          files: |
            firmware.bin
            checksums.txt
          body: |
            ## Battery Monitor Firmware ${{ github.ref_name }}
            
            ### ✅ Automatic OTA Updates
            This firmware includes automatic update checking! The device will:
            - Check for new versions on every wake cycle
            - Automatically download and install updates
            - Preserve all credentials across updates (stored in NVS)
            
            ### Firmware Files
            
            **Simple filenames (version in URL path):**
            - `firmware.bin` 
            
            **Download URL structure:**
            - `https://github.com/USERNAME/REPO/releases/download/${{ github.ref_name }}/firmware.bin`
            
            ### Setup Auto-Update
            1. Set target version via serial: `otaver ${{ steps.version.outputs.version }}`
            2. Save configuration: `save`
            3. Device automatically detects and installs on next wake
            
            ### Manual OTA Update via MQTT
            Force an immediate update by publishing to MQTT:
            ```bash
            mosquitto_pub -h YOUR_BROKER -t "battery/monitor/ota" -m "${{ github.ref_name }}/firmware.bin"
            ```
            
            ### First Time Setup (USB)
            1. Configure credentials locally:
               ```bash
               cp include/wifi_credentials.h.example include/wifi_credentials.h
               cp include/mqtt_credentials.h.example include/mqtt_credentials.h
               # Edit files with your credentials
               ```
            2. Upload via USB:
               ```bash
               pio run -e esp32dev -t upload
               ```
            3. Credentials saved to NVS - all future updates are OTA!
            
            ### Configuration
            - **Enable/disable auto-updates**: Set `AUTO_CHECK_OTA` in `battery_config.h`
            - **Set target version**: Use `otaver` command via serial
            - **Update server**: Set `OTA_BASE_URL` for your release downloads
            
            ### How It Works
            - Set target version using `otaver` command via serial
            - Device compares with built-in `FIRMWARE_VERSION` on wake
            - Constructs URL: `BASE_URL/v{target}/firmware-{type}.bin`
            - Downloads and installs if newer version available
            - Credentials persist in NVS across all updates ✓
            
            ### Checksums
            See `checksums.txt` for SHA256 checksums of all binaries.
          draft: false
          prerelease: false
